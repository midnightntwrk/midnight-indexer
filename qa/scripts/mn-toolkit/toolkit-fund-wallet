#!/bin/bash

set -e

# Check if the script is executed from the root directory
if [ ! -f "justfile" ]; then
    echo "Error: This script must be executed from the root directory of the project"
    exit 1
fi

CHAIN=$1
if [ -z "$CHAIN" ]; then
    echo "Please provide a chain id"
    echo "Usage: $0 <chain_id> <destination_seed> <amount> [source_seed] [node_tag]"
    exit 1
fi

if [ "$CHAIN" != "undeployed" ] && [ "$CHAIN" != "devnet" ] && [ "$CHAIN" != "testnet02" ] && [ "$CHAIN" != "nodedev01" ]; then
    echo "Please provide a valid chain id (undeployed, devnet, testnet02, nodedev01)"
    echo "Usage: $0 <chain_id> <destination_seed> <amount> [source_seed] [node_tag]"
    exit 1
fi

NETWORK_ID=""
case $CHAIN in
    "undeployed")
        CHAIN_URL="ws://localhost:9944"
        NETWORK_ID="undeployed"
        ;;
    "devnet")
        CHAIN_URL="wss://rpc.devnet.midnight.network"
        NETWORK_ID="devnet"
        ;;
    "testnet02")
        CHAIN_URL="wss://rpc.testnet02.midnight.network"
        NETWORK_ID="testnet"
        ;;
    "qanet")
        CHAIN_URL="wss://rpc.qanet.dev.midnight.network"
        NETWORK_ID="devnet"
        ;;
    "nodedev01")
        CHAIN_URL="wss://rpc.node-dev-01.dev.midnight.network"
        NETWORK_ID="devnet"
        ;;
esac

DESTINATION_SEED=$2
if [ -z "$DESTINATION_SEED" ]; then
    echo "Please provide a destination wallet seed"
    echo "Usage: $0 <chain_id> <destination_seed> <amount> [source_seed] [node_tag]"
    exit 1
fi

AMOUNT=$3
if [ -z "$AMOUNT" ]; then
    echo "Please provide an amount to send (in atomic units)"
    echo "Usage: $0 <chain_id> <destination_seed> <amount> [source_seed] [node_tag]"
    exit 1
fi

# Default source seed is the genesis wallet
SOURCE_SEED=$4
if [ -z "$SOURCE_SEED" ]; then
    SOURCE_SEED="0000000000000000000000000000000000000000000000000000000000000001"
    echo "Using default genesis wallet as source"
fi

# NODE_TAG is optional
NODE_TAG=$5
if [ -z "$NODE_TAG" ]; then
    echo "NODE_TAG not specified, deriving it from justfile"
    NODE_TAG=`cat justfile |grep "node_version :="|awk -F " " '{print $3}'|sed s/\"//g` 
    
    if [[ ! "$NODE_TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta|rc)\.[0-9]*)?$ ]]; then
        echo "Warning: NODE_TAG from justfile ($NODE_TAG) doesn't match expected format"
        NODE_TAG="0.17.0-rc.2"
    fi
    
    echo "NODE_TAG derived from justfile: $NODE_TAG"
fi

# Start toolkit if needed
bash qa/scripts/mn-toolkit/toolkit-start $CHAIN $NODE_TAG

echo ""
echo "========================================="
echo "Funding Wallet"
echo "========================================="
echo "Chain: $CHAIN"
echo "Amount: $AMOUNT"
echo ""

# Get destination address
echo "Getting destination wallet address..."
DEST_ADDRESS=$(docker run --rm --network host ghcr.io/midnight-ntwrk/midnight-node-toolkit:${NODE_TAG} show-address --network $NETWORK_ID --seed "$DESTINATION_SEED" --unshielded 2>/dev/null | grep -o 'mn_addr_[^"]*' | head -1)
echo "Destination address: $DEST_ADDRESS"
echo ""

# Send funds
echo "Sending $AMOUNT units to wallet..."
docker run --rm --network host ghcr.io/midnight-ntwrk/midnight-node-toolkit:${NODE_TAG} \
    generate-txs \
    --src-url $CHAIN_URL \
    --dest-url $CHAIN_URL \
    single-tx \
    --source-seed "$SOURCE_SEED" \
    --unshielded-amount $AMOUNT \
    --destination-address "$DEST_ADDRESS"

FUNDING_RESULT=$?

echo ""
echo "========================================="
if [ $FUNDING_RESULT -eq 0 ]; then
    echo "✓ Wallet funded successfully!"
    echo "========================================="
    echo ""
    echo "Wallet now has $AMOUNT units of unshielded Night"
    echo ""
    echo "Next steps:"
    echo "1. Check wallet state (DUST generation is automatic):"
    echo "   bash qa/scripts/mn-toolkit/toolkit-show-wallet $CHAIN $DESTINATION_SEED"
    echo ""
    echo "2. DUST generation begins automatically - no registration needed!"
else
    echo "✗ Wallet funding failed!"
    echo "========================================="
fi
echo ""

exit $FUNDING_RESULT

