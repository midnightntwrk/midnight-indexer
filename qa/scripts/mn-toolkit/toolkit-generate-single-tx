#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CHAIN=$1
if [ -z "$CHAIN" ]; then
    echo "Please provide a chain id"
    echo "Usage: $0 <chain_id> <seed>"
    exit 1
fi
if [ "$CHAIN" != "undeployed" ] && [ "$CHAIN" != "devnet" ] && [ "$CHAIN" != "testnet02" ] && [ "$CHAIN" != "nodedev01" ] && [ "$CHAIN" != "preview" ]; then
    echo "Please provide a valid chain id (undeployed, devnet, testnet02, nodedev01, preview)"
    echo "Usage: $0 <chain_id> <seed>"
    exit 1
fi

SEED=$2
if [ -z "$SEED" ]; then
    echo "Please provide a seed"
    echo "Usage: $0 <chain_id> <seed>"
    exit 1
fi

# Start the container (NODE_TAG will be read from environment or NODE_VERSION file)
"$SCRIPT_DIR/toolkit-start" $CHAIN

NETWORK_ID=""

#Switch case for the chain id
case $CHAIN in
    "undeployed")
        CHAIN_URL="ws://localhost:9944"
        NETWORK_ID="undeployed"
        ;;
    "devnet")
        CHAIN_URL="wss://rpc.devnet.midnight.network"
        NETWORK_ID="devnet"
        ;;
    "preview")
        CHAIN_URL="wss://rpc.preview.midnight.network"
        NETWORK_ID="devnet"
        ;;
    "testnet02")
        CHAIN_URL="wss://rpc.testnet02.midnight.network"
        NETWORK_ID="testnet"
        ;;
    "qanet")
        CHAIN_URL="wss://rpc.qanet.dev.midnight.network"
        NETWORK_ID="devnet"
        ;;
    "nodedev01")
        CHAIN_URL="wss://rpc.node-dev-01.dev.midnight.network"
        NETWORK_ID="devnet"
        ;;
esac

echo "Generating Destination Addresses off the wallet seed"
echo ""
DEST_WALLET_SEED="0000000000000000000000000000000000000000000000000000000987654321"

# Get address information (returns JSON with both shielded and unshielded addresses)
ADDRESSES_JSON=$("$SCRIPT_DIR/toolkit-show-address" $CHAIN $DEST_WALLET_SEED | tr -d '\r\n')
echo "Generated addresses: $ADDRESSES_JSON"

# Parse the JSON to extract shielded and unshielded addresses
# Note: This is a simple extraction, assuming the output format from the toolkit
DEST_SHIELDED_ADDR=$(echo "$ADDRESSES_JSON" | grep -oP '"shielded":\s*"\K[^"]+' || echo "")
DEST_UNSHIELDED_ADDR=$(echo "$ADDRESSES_JSON" | grep -oP '"unshielded":\s*"\K[^"]+' || echo "")

echo "DEST_SHIELDED_ADDR: $DEST_SHIELDED_ADDR"
echo "DEST_UNSHIELDED_ADDR: $DEST_UNSHIELDED_ADDR"


docker exec toolkit-${CHAIN} \
    /midnight-node-toolkit generate-txs \
    --src-url $CHAIN_URL \
    --dest-url $CHAIN_URL  \
    single-tx \
    --source-seed "$SEED" \
    --shielded-amount 1 \
    --unshielded-amount 2 \
    --destination-address "$DEST_SHIELDED_ADDR" \
    --destination-address "$DEST_UNSHIELDED_ADDR"
