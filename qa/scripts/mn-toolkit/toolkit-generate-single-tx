#!/bin/bash

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common functions
source "$SCRIPT_DIR/toolkit-common.sh"


# Auto-detect the environment from the running toolkit
ENVIRONMENT=$(get_toolkit_environment) || exit 1

# Validate environment using shared function
validate_environment "$ENVIRONMENT" || exit 1

# Get network configuration using the detected environment
get_network_config "$ENVIRONMENT" || exit 1
# Use CHAIN_URL for backward compatibility (same as NODE_URL)
CHAIN_URL=$NODE_URL

SEED=$1
if [ -z "$SEED" ]; then
    echo "Please provide a seed"
    echo "Usage: $0 <seed>"
    echo ""
    echo "Note: This script assumes a toolkit container is already running."
    echo "      Use 'toolkit-start <environment> [node_tag]' to start one first."
    exit 1
fi

echo "Generating Destination Addresses off the wallet seed"
echo ""
DEST_WALLET_SEED="0000000000000000000000000000000000000000000000000000000987654321"
ADDRESSES_JSON=$(bash toolkit-show-address $DEST_WALLET_SEED)
DEST_SHIELDED_ADDR=$(echo "$ADDRESSES_JSON" | jq -r '.shielded')
echo "DEST_SHIELDED_ADDR: $DEST_SHIELDED_ADDR"
DEST_UNSHIELDED_ADDR=$(echo "$ADDRESSES_JSON" | jq -r '.unshielded')
echo "DEST_UNSHIELDED_ADDR: $DEST_UNSHIELDED_ADDR"


# Use -it only if running in a TTY, otherwise just -i
if [ -t 0 ]; then
    DOCKER_FLAGS="-it"
else
    DOCKER_FLAGS="-i"
fi

# Debug: print the full docker command
echo "Running: docker exec $DOCKER_FLAGS toolkit-${ENVIRONMENT} /midnight-node-toolkit generate-txs --src-url $CHAIN_URL --dest-url $CHAIN_URL single-tx --source-seed \"$SEED\" --unshielded-amount 2 --destination-address \"$DEST_UNSHIELDED_ADDR\""
echo ""

docker exec $DOCKER_FLAGS toolkit-${ENVIRONMENT} \
    /midnight-node-toolkit generate-txs \
    --src-url $CHAIN_URL \
    --dest-url $CHAIN_URL  \
    single-tx \
    --source-seed "$SEED" \
    --unshielded-amount 2 \
    --destination-address "$DEST_UNSHIELDED_ADDR"
