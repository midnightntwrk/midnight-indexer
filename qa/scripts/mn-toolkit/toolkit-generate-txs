#!/bin/bash

set -e

bash scripts/toolkit-start $1 $3

# Check if the script is executed from the root directory
if [ ! -f "justfile" ]; then
    echo "Error: This script must be executed from the root directory of the project"
    exit 1
fi

CHAIN=$1
if [ -z "$CHAIN" ]; then
    echo "Please provide a chain id"
    echo "Usage: $0 <chain_id> <seed>"
    exit 1
fi
if [ "$CHAIN" != "undeployed" ] && [ "$CHAIN" != "devnet" ] && [ "$CHAIN" != "testnet02" ] && [ "$CHAIN" != "nodedev01" ]; then
    echo "Please provide a valid chain id (undeployed, devnet, testnet02, nodedev01)"
    echo "Usage: $0 <chain_id> <seed>"
    exit 1
fi

NETWORK_ID=""

#Switch case for the chain id
case $CHAIN in
    "undeployed")
        CHAIN_URL="ws://localhost:9944"
        NETWORK_ID="undeployed"
        ;;
    "devnet")
        CHAIN_URL="wss://rpc.devnet.midnight.network"
        NETWORK_ID="devnet"
        ;;
    "testnet02")
        CHAIN_URL="wss://rpc.testnet02.midnight.network"
        NETWORK_ID="testnet"
        ;;
    "qanet")
        CHAIN_URL="wss://rpc.qanet.dev.midnight.network"
        NETWORK_ID="devnet"
        ;;
    "nodedev01")
        CHAIN_URL="wss://rpc.node-dev-01.dev.midnight.network"
        NETWORK_ID="devnet"
        ;;
esac

SEED=$2
if [ -z "$SEED" ]; then
    echo "Please provide a seed"
    echo "Usage: $0 <chain_id> <seed>"
    exit 1
fi

# NODE_TAG is optional - if not provided, use default
NODE_TAG=$3
if [ -z "$NODE_TAG" ]; then
    # This is not ideal, NODE_TAG to use depends on the specific chain where node might be running
    # with another version
    echo "NODE_TAG not specified, deriving it from justfile"
    NODE_TAG=`cat justfile |grep "node_version :="|awk -F " " '{print $3}'|sed s/\"//g` 
    
    # Validate NODE_TAG format: <number>.<number>.<number><optional -alpha, -beta, -rc and number>
    if [[ ! "$NODE_TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta|rc)\.[0-9]*)?$ ]]; then
        echo "Warning: NODE_TAG from justfile ($NODE_TAG) doesn't match expected format"
        echo "Expected format: <number>.<number>.<number> or <number>.<number>.<number>-<alpha|beta|rc>[<number>]"
        echo "Using fallback NODE_TAG"
        NODE_TAG="0.13.2-rc.2"
    fi
    
    echo "NODE_TAG derived from justfile: $NODE_TAG"
fi

echo "Generating Destination Addresses off the wallet seed"
echo ""
DEST_WALLET_SEED="0000000000000000000000000000000000000000000000000000000987654321"
DEST_SHIELDED_ADDR=$(bash scripts/toolkit-show-address $CHAIN shielded $DEST_WALLET_SEED | tr -d '\r\n')
echo "DEST_SHIELDED_ADDR: $DEST_SHIELDED_ADDR"
DEST_UNSHIELDED_ADDR=$(bash scripts/toolkit-show-address $CHAIN unshielded $DEST_WALLET_SEED | tr -d '\r\n')
echo "DEST_UNSHIELDED_ADDR: $DEST_UNSHIELDED_ADDR"


docker exec -it toolkit-${CHAIN} \
    /midnight-node-toolkit generate-txs \
    --src-url $CHAIN_URL \
    --dest-url $CHAIN_URL  \
    single-tx \
    --source-seed "$SEED" \
    --shielded-amount 1 \
    --unshielded-amount 2 \
    --destination-address "$DEST_SHIELDED_ADDR" \
    --destination-address "$DEST_UNSHIELDED_ADDR"









