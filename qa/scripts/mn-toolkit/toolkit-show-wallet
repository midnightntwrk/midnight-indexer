#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CHAIN=$1
if [ -z "$CHAIN" ]; then
    # Find all toolkit-* containers
    CONTAINERS=$(docker ps --format "{{.Names}}" | grep "^toolkit-" || true)
    COUNT=$(echo "$CONTAINERS" | grep -c "^toolkit-" || true)
    
    if [ "$COUNT" -eq 0 ]; then
        echo "No toolkit containers found. Please start one first."
        exit 1
    elif [ "$COUNT" -eq 1 ]; then
        CHAIN=$(echo "$CONTAINERS" | sed 's/^toolkit-//')
        echo "Using chain: $CHAIN"
    else
        echo "Multiple toolkit containers found:"
        echo "$CONTAINERS"
        echo "Please specify which chain to use: $0 <chain_id> <seed> [options]"
        exit 1
    fi
fi

if [ "$CHAIN" != "undeployed" ] && [ "$CHAIN" != "devnet" ] && [ "$CHAIN" != "testnet02" ] && [ "$CHAIN" != "nodedev01" ] && [ "$CHAIN" != "preview" ]; then
    echo "Please provide a valid chain id (undeployed, devnet, testnet02, nodedev01, preview)"
    echo "Usage: $0 <chain_id> <seed> [--debug] [--dry-run] [--fetch-concurrency N]"
    exit 1
fi

SEED=$2
if [ -z "$SEED" ]; then
    echo "Please provide a seed"
    echo "Usage: $0 <chain_id> <seed> [--debug] [--dry-run] [--fetch-concurrency N]"
    exit 1
fi

# Start the container (NODE_TAG will be read from environment or NODE_VERSION file)
"$SCRIPT_DIR/toolkit-start" $CHAIN

# Determine the RPC URL based on chain
case $CHAIN in
    "undeployed")
        RPC_URL="ws://localhost:9944"
        ;;
    "devnet")
        RPC_URL="wss://rpc.devnet.midnight.network"
        ;;
    "preview")
        RPC_URL="wss://rpc.preview.midnight.network"
        ;;
    "testnet02")
        RPC_URL="wss://rpc.testnet02.midnight.network"
        ;;
    "qanet")
        RPC_URL="wss://rpc.qanet.dev.midnight.network"
        ;;
    "nodedev01")
        RPC_URL="wss://rpc.node-dev-01.dev.midnight.network"
        ;;
esac

# Collect any additional flags (e.g., --debug, --dry-run, etc.)
shift 2
EXTRA_FLAGS="$@"

echo "Showing wallet state for seed..."
docker exec toolkit-${CHAIN} \
    /midnight-node-toolkit show-wallet \
    --src-url $RPC_URL \
    --seed $SEED \
    $EXTRA_FLAGS

