#!/bin/bash

set -e

# Check if the script is executed from the root directory
if [ ! -f "justfile" ]; then
    echo "Error: This script must be executed from the root directory of the project"
    exit 1
fi

CHAIN=$1
if [ -z "$CHAIN" ]; then
    echo "Please provide a chain id"
    echo "Usage: $0 <chain_id> [node_tag]"
    exit 1
fi

if [ "$CHAIN" != "undeployed" ] && [ "$CHAIN" != "devnet" ] && [ "$CHAIN" != "testnet02" ] && [ "$CHAIN" != "nodedev01" ]; then
    echo "Please provide a valid chain id (undeployed, devnet, testnet02, nodedev01)"
    echo "Usage: $0 <chain_id> [node_tag]"
    exit 1
fi

NODE_TAG=$2
if [ -z "$NODE_TAG" ]; then
    # Use the version from .envrc.local
    NODE_TAG="0.17.1-47a8ea28"
    echo "Using NODE_TAG from .envrc.local: $NODE_TAG"
fi

# Check if container already exists
if docker ps -a --format "table {{.Names}}" | grep -q "toolkit-${CHAIN}"; then
    echo "Container toolkit-${CHAIN} already exists"
    if docker ps --format "table {{.Names}}" | grep -q "toolkit-${CHAIN}"; then
        echo "Container toolkit-${CHAIN} is already running"
        exit 0
    else
        echo "Starting existing container toolkit-${CHAIN}"
        docker start toolkit-${CHAIN}
        exit 0
    fi
fi

echo "Starting new container toolkit-${CHAIN} with NODE_TAG: $NODE_TAG"

# Start the toolkit container
docker run -d \
    --name toolkit-${CHAIN} \
    --network host \
    ghcr.io/midnight-ntwrk/midnight-node-toolkit:${NODE_TAG} \
    /bin/bash -c "while true; do sleep 3600; done"

echo "Toolkit container started successfully"
