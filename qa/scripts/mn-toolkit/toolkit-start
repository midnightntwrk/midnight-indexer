#!/bin/bash

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common functions
source "$SCRIPT_DIR/toolkit-common.sh"


ENVIRONMENT=$1
if [ -z "$ENVIRONMENT" ]; then
    echo "Please provide a chain id"
    echo "Usage: $0 <chain_id> [node_tag]"
    exit 1
fi

# Validate environment using shared function
validate_environment "$ENVIRONMENT" || exit 1

# Get NODE_TAG from second argument, or use default from NODE_VERSION file
NODE_TAG=${2:-$(cat NODE_VERSION 2>/dev/null || echo "latest")}

TARGET_DIR=./.tmp/toolkit

mkdir -p $TARGET_DIR
mkdir -p $TARGET_DIR/.sync_cache-$ENVIRONMENT

CONTAINER_NAME="toolkit-${ENVIRONMENT}"

# Check if container is already running
if docker ps --format "table {{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    echo "Container ${CONTAINER_NAME} is already running"
    exit 0
fi

# Check if container exists but is stopped
if docker ps -a --format "table {{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    echo "Container ${CONTAINER_NAME} exists but is stopped. Starting it..."
    docker start "$CONTAINER_NAME"
    exit 0
fi

echo "Starting new container ${CONTAINER_NAME} with NODE_TAG: $NODE_TAG"

docker run \
    -d \
    --name "$CONTAINER_NAME" \
    --entrypoint "" \
    --network host \
    -v $TARGET_DIR:/out \
    -v $TARGET_DIR/.sync_cache-$ENVIRONMENT:/.sync_cache \
    ghcr.io/midnight-ntwrk/midnight-node-toolkit:$NODE_TAG \
    sleep infinity
